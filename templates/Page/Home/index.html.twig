{% extends 'Layout/base.html.twig' %}

{% block body %}
    <section class="bg-gradient-to-b from-gray-900 to-gray-950">
        <div class="max-w-6xl mx-auto px-6 pt-24 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6">
                {{ website_title }}
            </h1>

            <p class="text-gray-400 max-w-2xl mx-auto">
                {{ website_description }}
            </p>
        </div>
    </section>

    <section class="max-w-4xl mx-auto px-6 py-20">
        <div id="posts-root"></div>
    </section>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const {useEffect, useRef, useState} = React;

        function Posts() {
            const [posts, setPosts] = useState([]);
            const [page, setPage] = useState(1);
            const [loading, setLoading] = useState(false);
            const [done, setDone] = useState(false);
            const loaderRef = useRef(null);

            async function loadPosts() {
                if (loading || done) return;

                setLoading(true);

                const response = await fetch(`/posts?page=${page}&limit=5`);
                const data = await response.json();

                if (data.length === 0) {
                    setDone(true);
                } else {
                    setPosts(prev => [...prev, ...data]);
                    setPage(prev => prev + 1);
                }

                setLoading(false);
            }

            useEffect(() => {
                loadPosts();
            }, []);

            useEffect(() => {
                const observer = new IntersectionObserver(entries => {
                    if (entries[0].isIntersecting) {
                        loadPosts();
                    }
                });

                if (loaderRef.current) {
                    observer.observe(loaderRef.current);
                }

                return () => observer.disconnect();
            }, [loading, done]);

            function deletePost(id) {
                if (!confirm('Supprimer ce post ?')) return;

                fetch(`/post/${id}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(() => {
                    setPosts(prev => prev.filter(p => p.id !== id));
                });
            }

            return (
                <>
                    <div className="space-y-10">
                        {posts.map(post => (
                            <article
                                key={post.id}
                                className="bg-slate-900/40 backdrop-blur rounded-xl p-8"
                            >
                                <div className="flex items-start justify-between mb-4">
                                    <div>
                                        <h2 className="text-2xl font-semibold">
                                            {post.title}
                                        </h2>
                                        <span className="text-sm text-slate-400">
                                            {post.author}
                                        </span>
                                    </div>

                                    {post.manageable && (
                                        <div className="flex gap-2">
                                            <a
                                                href={`/post/${post.id}/update`}
                                                className="px-3 py-1 text-sm border border-slate-600 rounded hover:border-slate-400"
                                            >
                                                Modifier
                                            </a>

                                            <button
                                                onClick={() => deletePost(post.id)}
                                                className="px-3 py-1 text-sm border border-red-500 text-red-400 rounded hover:bg-red-500 hover:text-white"
                                            >
                                                Supprimer
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <img srcSet={post.url} alt={post.title}
                                     className="w-full rounded-lg border border-slate-800"/>
                                {post.content && (
                                    <p className="text-slate-400 leading-relaxed">
                                        {post.content}
                                    </p>
                                )}
                            </article>
                        ))}
                    </div>

                    <div
                        ref={loaderRef}
                        className="text-center text-slate-500 mt-10"
                    >
                        {done ? 'Fin des posts' : 'Chargementâ€¦'}
                    </div>
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('posts-root')).render(<Posts/>);
    </script>
{% endblock %}
